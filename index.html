<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explicando a B√≠blia</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            purple: '#7c3aed',
                            blue: '#2563eb',
                            green: '#10b981',
                            gold: '#fbbf24',
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tesseract.js for OCR -->
    <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>

    <!-- Google Gemini SDK Import Map -->
    <script type="importmap">
    {
        "imports": {
            "@google/genai": "https://esm.run/@google/genai"
        }
    }
    </script>

    <style>
        body {
            background-color: #020617; /* Slate 950 */
            color: #f8fafc;
        }
        .gradient-text {
            background: linear-gradient(to right, #a78bfa, #34d399, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- ICONS (SVG Components) ---
        const SearchIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        );
        const CameraIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        );
        const BookIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
        );
        const ShareIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
        );
        const LoaderIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );
        const XIcon = ({ className, onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const ChevronRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
        );

        // --- COMPONENTS ---

        // Input Mode Switcher
        const TabButton = ({ active, onClick, icon: Icon, label }) => (
            <button 
                onClick={onClick}
                className={`flex items-center justify-center gap-2 px-6 py-3 rounded-full transition-all duration-300 w-full sm:w-auto ${
                    active 
                    ? 'bg-gradient-to-r from-brand-blue to-brand-purple text-white shadow-lg shadow-brand-purple/30' 
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                }`}
            >
                <Icon className="w-5 h-5" />
                <span className="font-medium">{label}</span>
            </button>
        );

        // Result Section Card
        const ExplanationCard = ({ title, content, colorClass }) => (
            <div className="glass-card rounded-xl p-6 mb-4 border-l-4 transition-all hover:translate-x-1" style={{ borderLeftColor: colorClass }}>
                <h3 className="text-xl font-bold mb-3 text-slate-100 flex items-center gap-2">
                    <ChevronRight className="w-5 h-5 text-slate-400" />
                    {title}
                </h3>
                <div className="text-slate-300 leading-relaxed space-y-2">
                    {Array.isArray(content) ? (
                        <ul className="list-disc list-inside space-y-1 ml-2">
                            {content.map((item, idx) => <li key={idx}>{item}</li>)}
                        </ul>
                    ) : (
                        <p>{content}</p>
                    )}
                </div>
            </div>
        );

        // --- MAIN APP COMPONENT ---
        
        const App = () => {
            const [mode, setMode] = React.useState('text'); // 'text' | 'camera'
            const [inputText, setInputText] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [statusMessage, setStatusMessage] = React.useState('');
            const [result, setResult] = React.useState(null);
            const [apiKey, setApiKey] = React.useState(process.env.API_KEY || ''); 
            
            // Camera Refs
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);
            const [cameraStream, setCameraStream] = React.useState(null);

            // Setup API Key on mount if not in env (For GH Pages demo)
            React.useEffect(() => {
                // This is a workaround for the GitHub Pages static environment where process.env isn't available
                if (!apiKey) {
                    const storedKey = localStorage.getItem('gemini_api_key');
                    if (storedKey) {
                        setApiKey(storedKey);
                    } else {
                        // Small delay to allow render
                        setTimeout(() => {
                            const key = prompt("Por favor, insira sua chave de API do Google Gemini para usar o app:");
                            if (key) {
                                setApiKey(key);
                                localStorage.setItem('gemini_api_key', key);
                            }
                        }, 1000);
                    }
                }
            }, []);

            // Cleanup camera on unmount or mode change
            React.useEffect(() => {
                return () => {
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                    }
                };
            }, [cameraStream]);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    setCameraStream(stream);
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Erro ao acessar c√¢mera:", err);
                    alert("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.");
                }
            };

            const stopCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    setCameraStream(null);
                }
            };

            const captureAndOCR = async () => {
                if (!videoRef.current || !canvasRef.current) return;

                setLoading(true);
                setStatusMessage('Capturando imagem e lendo texto (OCR)...');

                const video = videoRef.current;
                const canvas = canvasRef.current;
                const context = canvas.getContext('2d');

                // Set canvas dimensions to video dimensions
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Stop camera preview
                stopCamera();

                try {
                    // Tesseract OCR
                    const { data: { text } } = await Tesseract.recognize(
                        canvas,
                        'por',
                        { logger: m => {
                            if(m.status === 'recognizing text') {
                                setStatusMessage(`Lendo texto: ${Math.round(m.progress * 100)}%`);
                            }
                        }}
                    );

                    if (!text || text.trim().length < 10) {
                        throw new Error("N√£o foi poss√≠vel identificar texto leg√≠vel. Tente novamente com mais luz.");
                    }

                    setInputText(text); // Set text for review
                    setMode('text'); // Switch to text mode to show what was found
                    handleExplain(text); // Auto trigger explanation

                } catch (error) {
                    console.error(error);
                    setStatusMessage('Erro na leitura da imagem.');
                    alert(error.message);
                    setLoading(false);
                }
            };

            const handleExplain = async (textToExplain) => {
                const query = textToExplain || inputText;
                if (!query) return;

                setLoading(true);
                setStatusMessage('Consultando intelig√™ncia artificial...');
                setResult(null);

                try {
                    if (!apiKey) throw new Error("Chave de API n√£o configurada.");

                    const ai = new GoogleGenAI({ apiKey: apiKey });
                    
                    // Use Gemini 2.5 Flash for speed and quality
                    const modelName = 'gemini-2.5-flash';
                    
                    const prompt = `
                        Voc√™ √© um especialista b√≠blico e te√≥logo moderno voltado para jovens e adultos contempor√¢neos.
                        Analise o seguinte texto ou refer√™ncia b√≠blica: "${query}".
                        
                        Se o texto for inconclusivo, responda com um JSON contendo "error": "Texto n√£o reconhecido como b√≠blico".
                        
                        Caso contr√°rio, retorne um objeto JSON estrito (sem markdown code blocks) com a seguinte estrutura:
                        {
                            "reference": "Livro Capitulo:Versiculo (ex: Jo√£o 3:16)",
                            "summary": "Um resumo moderno e curto (m√°x 2 linhas)",
                            "historicalContext": "O que estava acontecendo na √©poca, quem escreveu e para quem.",
                            "explanation": "Explica√ß√£o detalhada em linguagem simples, atual e inspiradora.",
                            "application": "Como aplicar isso na vida pr√°tica hoje (trabalho, fam√≠lia, ansiedade, etc).",
                            "reflectionQuestions": ["Pergunta 1?", "Pergunta 2?", "Pergunta 3?"]
                        }
                    `;

                    const response = await ai.models.generateContent({
                        model: modelName,
                        contents: prompt,
                        config: {
                            responseMimeType: "application/json"
                        }
                    });

                    const jsonText = response.text;
                    const data = JSON.parse(jsonText);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    setResult(data);

                } catch (error) {
                    console.error("Erro na API:", error);
                    alert("Erro ao gerar explica√ß√£o: " + error.message);
                } finally {
                    setLoading(false);
                    setStatusMessage('');
                }
            };

            const shareContent = (platform) => {
                if (!result) return;
                const text = `üìñ *${result.reference}*\n\n"${result.summary}"\n\nVeja a explica√ß√£o completa em Explicando a B√≠blia!`;
                const url = window.location.href;
                
                let shareUrl = '';
                if (platform === 'whatsapp') shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
                if (platform === 'twitter') shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
                if (platform === 'facebook') shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                
                window.open(shareUrl, '_blank');
            };

            return (
                <div className="min-h-screen pb-12 px-4 sm:px-6 font-sans selection:bg-brand-purple selection:text-white">
                    
                    {/* Header */}
                    <header className="pt-10 pb-8 text-center max-w-3xl mx-auto">
                        <div className="inline-flex items-center justify-center p-3 mb-4 rounded-2xl bg-slate-900 border border-slate-800 shadow-xl">
                            <BookIcon className="w-8 h-8 text-brand-gold" />
                        </div>
                        <h1 className="text-4xl sm:text-5xl font-extrabold tracking-tight mb-2">
                            Explicando a <span className="gradient-text">B√≠blia</span>
                        </h1>
                        <p className="text-slate-400 text-lg">
                            Sabedoria antiga para tempos modernos.
                        </p>
                    </header>

                    {/* Main Interface */}
                    <main className="max-w-2xl mx-auto">
                        
                        {/* Mode Switcher */}
                        <div className="flex flex-col sm:flex-row justify-center gap-4 mb-8">
                            <TabButton 
                                active={mode === 'text'} 
                                onClick={() => { setMode('text'); stopCamera(); }} 
                                icon={BookIcon} 
                                label="Digitar Passagem" 
                            />
                            <TabButton 
                                active={mode === 'camera'} 
                                onClick={() => { setMode('camera'); startCamera(); setResult(null); }} 
                                icon={CameraIcon} 
                                label="Usar C√¢mera" 
                            />
                        </div>

                        {/* Text Input Area */}
                        {mode === 'text' && (
                            <div className="glass-card p-2 rounded-2xl flex items-center shadow-2xl mb-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <input 
                                    type="text" 
                                    className="flex-1 bg-transparent border-none text-white px-4 py-3 focus:outline-none placeholder-slate-500 text-lg"
                                    placeholder="Ex: Jo√£o 3:16 ou Salmos 23"
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleExplain()}
                                />
                                <button 
                                    onClick={() => handleExplain()}
                                    disabled={loading || !inputText}
                                    className="bg-brand-blue hover:bg-blue-600 text-white p-3 rounded-xl transition-colors disabled:opacity-50"
                                >
                                    {loading ? <LoaderIcon className="animate-spin w-6 h-6"/> : <SearchIcon className="w-6 h-6" />}
                                </button>
                            </div>
                        )}

                        {/* Camera Area */}
                        {mode === 'camera' && (
                            <div className="relative rounded-2xl overflow-hidden shadow-2xl border border-slate-700 bg-black mb-8 animate-in zoom-in duration-300">
                                {loading ? (
                                    <div className="h-64 sm:h-96 flex flex-col items-center justify-center gap-4 text-slate-400">
                                        <LoaderIcon className="w-10 h-10 animate-spin text-brand-purple"/>
                                        <p>{statusMessage}</p>
                                    </div>
                                ) : (
                                    <>
                                        <video 
                                            ref={videoRef} 
                                            autoPlay 
                                            playsInline 
                                            className="w-full h-64 sm:h-96 object-cover"
                                        />
                                        <canvas ref={canvasRef} className="hidden" />
                                        
                                        {/* Camera Overlay */}
                                        <div className="absolute inset-0 border-[40px] border-black/50 pointer-events-none flex items-center justify-center">
                                            <div className="w-full h-0.5 bg-red-500/50"></div>
                                        </div>

                                        <div className="absolute bottom-4 left-0 right-0 flex justify-center z-10">
                                            <button 
                                                onClick={captureAndOCR}
                                                className="bg-white text-black rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:scale-105 transition-transform"
                                            >
                                                <div className="w-14 h-14 rounded-full border-2 border-black"></div>
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* Loading State for Text Mode */}
                        {loading && mode === 'text' && (
                            <div className="text-center py-12 animate-pulse">
                                <LoaderIcon className="w-12 h-12 text-brand-purple mx-auto animate-spin mb-4" />
                                <p className="text-slate-400 text-lg">{statusMessage}</p>
                            </div>
                        )}

                        {/* Results Display */}
                        {result && !loading && (
                            <div className="animate-in slide-in-from-bottom-8 duration-700">
                                <div className="text-center mb-8">
                                    <span className="inline-block px-4 py-1 rounded-full bg-brand-purple/20 text-brand-purple text-sm font-semibold mb-2 uppercase tracking-wide">
                                        Explica√ß√£o Gerada
                                    </span>
                                    <h2 className="text-3xl font-bold text-white">{result.reference}</h2>
                                </div>

                                <ExplanationCard 
                                    title="Resumo Moderno" 
                                    content={result.summary} 
                                    colorClass="#fbbf24" 
                                />
                                
                                <ExplanationCard 
                                    title="Contexto Hist√≥rico" 
                                    content={result.historicalContext} 
                                    colorClass="#f97316" 
                                />

                                <div className="glass-card rounded-xl p-8 mb-4 border-t-4 border-brand-blue shadow-2xl shadow-brand-blue/10">
                                    <h3 className="text-2xl font-bold mb-4 text-white">Explica√ß√£o</h3>
                                    <p className="text-lg text-slate-200 leading-relaxed whitespace-pre-line">
                                        {result.explanation}
                                    </p>
                                </div>

                                <ExplanationCard 
                                    title="Aplica√ß√£o Pr√°tica" 
                                    content={result.application} 
                                    colorClass="#10b981" 
                                />

                                <ExplanationCard 
                                    title="Para Reflex√£o" 
                                    content={result.reflectionQuestions} 
                                    colorClass="#a78bfa" 
                                />

                                {/* Social Sharing */}
                                <div className="mt-8 flex justify-center gap-4">
                                    <button onClick={() => shareContent('whatsapp')} className="bg-[#25D366] hover:bg-[#20bd5a] text-white px-4 py-2 rounded-lg flex items-center gap-2 font-semibold transition-transform hover:-translate-y-1">
                                        WhatsApp
                                    </button>
                                    <button onClick={() => shareContent('twitter')} className="bg-[#1DA1F2] hover:bg-[#1a91da] text-white px-4 py-2 rounded-lg flex items-center gap-2 font-semibold transition-transform hover:-translate-y-1">
                                        X / Twitter
                                    </button>
                                    <button onClick={() => shareContent('facebook')} className="bg-[#4267B2] hover:bg-[#365899] text-white px-4 py-2 rounded-lg flex items-center gap-2 font-semibold transition-transform hover:-translate-y-1">
                                        Facebook
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="mt-20 text-center text-slate-600 text-sm">
                        <p>Desenvolvido com IA ‚Ä¢ React ‚Ä¢ Tailwind ‚Ä¢ Gemini</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>